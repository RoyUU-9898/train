<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ç£éµè·¯è»Šç«™é…å°éŠæˆ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; }
    body { box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }

    .station-card { cursor: grab; transition: all 0.2s ease; user-select: none; }
    .station-card:active { cursor: grabbing; }
    .station-card.dragging { opacity: 0.7; transform: scale(1.05) rotate(2deg); }

    @keyframes bounce-in {
      0% { transform: scale(0.98); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .bounce-in { animation: bounce-in 0.25s ease-out; }

    .info-panel { background: linear-gradient(135deg, #fef3c7, #fde68a); }

    /* å·¦å´æ–¹æ¡† */
    .label-box {
      border-radius: 16px;
      padding: 10px 10px;
      font-weight: 700;
      font-size: 12px;
      line-height: 1.1;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(6px);
      border: 2px dashed rgba(252, 211, 77, 0.9);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      user-select: none;
    }
    .label-box.droppable { cursor: pointer; }
    .label-box.drag-over {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 0 18px rgba(34,197,94,0.35);
      border-color: rgba(34,197,94,0.9);
      background: rgba(236, 253, 245, 0.95);
    }
    .label-box.matched {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: white;
      border: none;
      cursor: pointer;
    }
    .label-box.matched:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.22);
    }

    /* âœ… iPad æ©«å‘ï¼šæ•´é ç¸®æ”¾ï¼Œé¿å…ç®­é ­é£„ */
    @media (min-width: 768px) and (max-width: 1200px) and (orientation: landscape) {
      body { overflow: hidden; }
      #app { padding: 6px !important; }

      header { margin-bottom: 6px !important; }
      #game-title { font-size: 22px !important; line-height: 1.2; margin-bottom: 4px !important; }
      #instruction-text { font-size: 13px !important; }

      .scale-wrap {
        transform: scale(0.92);
        transform-origin: top center;
      }

      #info-panel { min-height: 210px !important; }
      #cards-container { min-height: 96px !important; }
    }

    /* âœ… é¢¨æ™¯åœ–å¯é»æ“Šæç¤º */
    .zoomable-photo { cursor: zoom-in; }

    /* âœ… æ”¾å¤§åœ– Modal */
    .photo-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 14px;
      backdrop-filter: blur(2px);
    }
    .photo-modal.show { display: flex; }

    .photo-modal-card {
      position: relative;
      width: min(980px, 96vw);
      max-height: 92vh;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 18px;
      padding: 10px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .photo-modal-img {
      width: 100%;
      height: auto;
      max-height: 86vh;
      object-fit: contain;
      border-radius: 14px;
      display: block;
      background: rgba(255,255,255,0.05);
    }
    .photo-modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 44px;
      height: 44px;
      border-radius: 9999px;
      border: 1px solid rgba(255,255,255,0.28);
      background: rgba(0,0,0,0.45);
      color: white;
      font-size: 22px;
      line-height: 44px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .photo-modal-close:active { transform: scale(0.98); }
  </style>
</head>

<body class="h-full bg-gradient-to-br from-sky-100 via-blue-50 to-emerald-50 overflow-auto">
  <div id="app" class="w-full min-h-full p-4">

    <header class="text-center mb-4">
      <h1 id="game-title" class="text-2xl md:text-3xl font-bold text-blue-600 mb-2">ğŸš‚ å°ç£éµè·¯è»Šç«™é…å°éŠæˆ² ğŸšƒ</h1>
      <p id="instruction-text" class="text-gray-600 text-sm md:text-base">æŠŠå³é‚Šçš„è»Šç«™åç¨±æ‹–åˆ°å·¦é‚Šæ­£ç¢ºçš„æ–¹æ¡†å§ï¼</p>
    </header>

    <div class="scale-wrap">
      <div class="flex flex-col lg:flex-row gap-4 max-w-7xl mx-auto">

        <!-- Left: Map -->
        <div class="lg:w-2/3 bg-white rounded-3xl shadow-xl p-4">
          <div class="flex items-center justify-center mb-3">
            <span class="text-lg font-bold text-slate-700">ğŸ—ºï¸ åŒ—è¿´ç·šéµè·¯åœ°åœ–</span>
          </div>

          <div class="relative w-full overflow-hidden rounded-3xl bg-slate-50" id="map-wrap">
            <img
              id="rail-map"
              src="./image.psd.jpg"
              class="w-full h-auto block select-none pointer-events-none"
              alt="rail map"
            />

            <svg id="links-layer"
                 class="absolute inset-0 w-full h-full pointer-events-none"
                 viewBox="0 0 100 100"
                 preserveAspectRatio="none">
              <defs>
                <marker id="arrowhead" markerWidth="4" markerHeight="4" refX="3.5" refY="2" orient="auto">
                  <path d="M0,0 L4,2 L0,4 Z" fill="rgba(51,65,85,0.75)"></path>
                </marker>
              </defs>
            </svg>

            <div id="stations-container" class="absolute inset-0 pointer-events-none"></div>

            <div id="labels-container"
                 class="absolute top-2 bottom-2 left-2 flex flex-col justify-between gap-2 w-[170px] pointer-events-auto">
            </div>
          </div>

          <p class="text-xs text-slate-500 mt-2 text-center">
            æ–¹æ¡†ç‚ºé…å°ç›®æ¨™ï¼ˆæ‹–åˆ°æ–¹æ¡†ï¼‰ï¼›é…å°å®Œæˆå¾Œå¯é»æ“Šæ–¹æ¡†æŸ¥çœ‹ç‰¹è‰²ã€‚
          </p>
        </div>

        <!-- Right Panel -->
        <div class="lg:w-1/3 flex flex-col gap-4">

          <!-- Cards -->
          <div class="bg-white rounded-3xl shadow-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-orange-600">ğŸ´ è»Šç«™å¡ç‰‡</span>
              <button id="reset-btn"
                class="bg-gradient-to-r from-pink-400 to-rose-400 text-white px-4 py-2 rounded-full text-sm font-bold hover:from-pink-500 hover:to-rose-500 transition-all shadow-md hover:shadow-lg">
                ğŸ”„ é‡æ–°é–‹å§‹
              </button>
            </div>

            <div id="cards-container" class="flex flex-wrap gap-2 justify-center min-h-[120px]"></div>

            <div id="progress-bar" class="mt-3 bg-gray-200 rounded-full h-3 overflow-hidden">
              <div id="progress-fill"
                class="bg-gradient-to-r from-green-400 to-emerald-500 h-full transition-all duration-500"
                style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center text-sm text-gray-500 mt-1">é…å°é€²åº¦ï¼š0 / 11</p>
          </div>

          <!-- Info Panel -->
          <div id="info-panel" class="info-panel rounded-3xl shadow-xl p-4 min-h-[280px] flex flex-col">
            <div id="info-content" class="h-full flex flex-col">
              <div class="text-center">
                <div class="text-5xl mb-2">ğŸ—ºï¸</div>
                <p class="text-amber-800 font-bold text-lg">é»æ“Šå·²é…å°çš„æ–¹æ¡†</p>
                <p class="text-amber-700 text-sm mt-1">ä¸‹æ–¹æœƒé¡¯ç¤ºè©²ç«™ç‰¹è‰²èˆ‡é¢¨æ™¯åœ–</p>
              </div>

              <div class="mt-3 flex-1 rounded-2xl bg-white/60 border border-amber-200 p-3 flex items-center justify-center text-amber-700 text-sm">
                é¢¨æ™¯åœ–æš«å­˜å€æœƒåœ¨ä½ é»é¸è»Šç«™å¾Œå‡ºç¾ âœ¨
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- æ”¾å¤§åœ– Modal -->
  <div id="photo-modal" class="photo-modal" aria-hidden="true">
    <div class="photo-modal-card" role="dialog" aria-modal="true" aria-label="æ”¾å¤§åœ–ç‰‡">
      <div id="photo-modal-close" class="photo-modal-close" aria-label="é—œé–‰">âœ•</div>
      <img id="photo-modal-img" class="photo-modal-img" alt="æ”¾å¤§é¢¨æ™¯åœ–" />
    </div>
  </div>

  <script>
    const defaultConfig = {
      game_title: 'ğŸš‚ å°ç£éµè·¯è»Šç«™é…å°éŠæˆ² ğŸšƒ',
      instruction_text: 'æŠŠå³é‚Šçš„è»Šç«™åç¨±æ‹–åˆ°å·¦é‚Šæ­£ç¢ºçš„æ–¹æ¡†å§ï¼'
    };

    const stationsData = [
      {
        id: 'songshan',
        name: 'æ¾å±±',
        bullets: [
          'å°åŒ—é‡è¦äº¤é€šèˆ‡å•†æ¥­æ ¸å¿ƒï¼Œæ¾å±±è»Šç«™ã€æ·é‹äº¤æœƒ',
          'é¥’æ²³è¡—å¤œå¸‚ï¼Œä»£è¡¨æ€§å°å¼å¤œå¸‚æ–‡åŒ–',
          'é„°è¿‘æ¾å±±æ–‡å‰µåœ’å€ï¼Œçµåˆæ­·å²èˆ‡å‰µæ„ç”¢æ¥­'
        ],
        imageUrl: './songshan.jpg'
      },
      {
        id: 'ruifang',
        name: 'ç‘èŠ³',
        bullets: [
          'å±±æµ·äº¤æœƒçš„ç¤¦æ¥­åŸé®',
          'é€šå¾€ä¹ä»½ã€é‡‘ç“œçŸ³çš„é‡è¦é–€æˆ¶',
          'æ“æœ‰æ¿ƒåšæ—¥æ²»æ™‚æœŸç¤¦æ¥­æ­·å²'
        ],
        imageUrl: './ruifang.jpg'
      },
      {
        id: 'houtong',
        name: 'çŒ´ç¡',
        bullets: [
          'ä¸–ç•ŒçŸ¥åã€Œè²“æ‘ã€ï¼Œè§€å…‰ç‰¹è‰²é®®æ˜',
          'èˆŠç¤¦å€è½‰å‹æˆåŠŸçš„å…¸ç¯„',
          'å±±åŸéµé“èšè½ï¼Œé¢¨æ™¯æ¸…å¹½'
        ],
        imageUrl: './houtong.jpg'
      },
      {
        id: 'sandiaoling',
        name: 'ä¸‰è²‚å¶º',
        bullets: [
          'éµé“è¿·å¿…è¨ªçš„ç§˜å¢ƒè»Šç«™',
          'ç’°ç¹æºªè°·ã€ç€‘å¸ƒèˆ‡åŸå§‹è‡ªç„¶',
          'äººç…™ç¨€å°‘ï¼Œä¿æœ‰ç´”æ¨¸å±±æ—æ„Ÿ'
        ],
        imageUrl: './sandiaoling.jpg'
      },
      {
        id: 'mudan',
        name: 'ç‰¡ä¸¹',
        bullets: [
          'å°å‹è¾²æ‘èšè½ï¼Œç¯€å¥ç·©æ…¢',
          'å‘¨é‚Šè‡ªç„¶æ™¯è§€å®Œæ•´',
          'ä¿æœ‰æ—©æœŸéµè·¯æ”¯ç·šæ°›åœ'
        ],
        imageUrl: './mudan.jpg'
      },
      {
        id: 'shuangxi',
        name: 'é›™æºª',
        bullets: [
          'æ²³æµäº¤æœƒå½¢æˆçš„å±±åŸèšè½',
          'é©åˆå¥è¡Œã€æº¯æºªèˆ‡å¤é“æ—…è¡Œ',
          'ä»ä¿æœ‰å‚³çµ±é„‰é®ç”Ÿæ´»æ¨£è²Œ'
        ],
        imageUrl: './shuangxi.jpg'
      },
      {
        id: 'gongliao',
        name: 'è²¢å¯®',
        bullets: [
          'æ±åŒ—è§’æµ·å²¸ç·šçš„é‡è¦å€åŸŸ',
          'çµåˆæ¼æ‘æ–‡åŒ–èˆ‡è‡ªç„¶æµ·æ™¯æµ·æ´‹',
          'éŸ³æ¨‚ç¥­èˆ‰è¾¦åœ°'
        ],
        imageUrl: './gongliao.jpg'
      },
      {
        id: 'fulong',
        name: 'ç¦éš†',
        bullets: [
          'è‡ºç£æœ€çŸ¥åçš„æ²™ç˜ä¹‹ä¸€',
          'ç¦éš†ä¾¿ç•¶æ˜¯éµè·¯ç¾é£Ÿä»£è¡¨',
          'å¤å­£è§€å…‰èˆ‡éŸ³æ¨‚æ´»å‹•ç†±é»'
        ],
        imageUrl: './fulong.jpg'
      },
      {
        id: 'yilan',
        name: 'å®œè˜­',
        bullets: [
          'å¹³åŸè¾²æ¥­èˆ‡æ…¢æ´»åŸå¸‚å½¢è±¡',
          'ç¾é£Ÿå¯†é›†ï¼ˆè”¥æ²¹é¤…ã€é´¨è³ç­‰ï¼‰',
          'å±±æµ·è³‡æºè±å¯Œï¼Œè§€å…‰å¤šå…ƒ'
        ],
        imageUrl: './yilan.jpg'
      },
      {
        id: 'suao',
        name: 'è˜‡æ¾³',
        bullets: [
          'æ¼æ¸¯åŸå¸‚ï¼Œæµ·é®®æ–‡åŒ–æ¿ƒåš',
          'è˜‡æ¾³å†·æ³‰ï¼Œä¸–ç•Œå°‘è¦‹è‡ªç„¶æ™¯è§€',
          'éµè·¯èˆ‡æ¸¯å£ä¸¦å­˜çš„é‡è¦åŸé®'
        ],
        imageUrl: './suao.jpg'
      },
      {
        id: 'hualien',
        name: 'èŠ±è“®',
        bullets: [
          'å±±æµ·æ™¯è§€ä¸¦å­˜ï¼Œè‡ªç„¶è³‡æºè±å¯Œ',
          'å¤ªé­¯é–£åœ‹å®¶å…¬åœ’å…¥å£åŸå¸‚',
          'åŸä½æ°‘æ–‡åŒ–èˆ‡æ…¢æ´»æ—…éŠä»£è¡¨'
        ],
        imageUrl: './hualien.jpg'
      },
    ];

    const stationPositions = {
      songshan:    { left: 71.3921, top: 21.7455 },
      ruifang:     { left: 83.8485, top: 17.3941 },
      houtong:     { left: 85.3277, top: 18.6803 },
      sandiaoling: { left: 85.1615, top: 20.6331 },
      mudan:       { left: 87.6282, top: 21.2583 },
      shuangxi:    { left: 87.9982, top: 23.2591 },
      gongliao:    { left: 90.9581, top: 23.5092 },
      fulong:      { left: 93.2906, top: 24.2098 },
      yilan:       { left: 81.9706, top: 40.8866 },
      suao:        { left: 88.0022, top: 51.8680 },
      hualien:     { left: 73.1468, top: 91.5765 },
    };

    let matchedStations = new Set();
    let currentCards = [];
    let draggedCard = null;

    // touch
    let clonedCard = null;

    /* æ”¾å¤§åœ– Modal æ§åˆ¶ */
    const photoModal = document.getElementById('photo-modal');
    const photoModalImg = document.getElementById('photo-modal-img');
    const photoModalClose = document.getElementById('photo-modal-close');

    function openPhotoModal(src, altText) {
      if (!photoModal || !photoModalImg) return;
      photoModalImg.src = src;
      photoModalImg.alt = altText || 'æ”¾å¤§é¢¨æ™¯åœ–';
      photoModal.classList.add('show');
      photoModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closePhotoModal() {
      if (!photoModal || !photoModalImg) return;
      photoModal.classList.remove('show');
      photoModal.setAttribute('aria-hidden', 'true');
      photoModalImg.src = '';
      document.body.style.overflow = '';
    }

    if (photoModalClose) {
      photoModalClose.addEventListener('click', closePhotoModal);
    }
    if (photoModal) {
      photoModal.addEventListener('click', (e) => {
        if (e.target === photoModal) closePhotoModal();
      });
    }
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && photoModal && photoModal.classList.contains('show')) {
        closePhotoModal();
      }
    });

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function redrawLinksUsingLabelRects() {
      const svg = document.getElementById('links-layer');
      const mapWrap = document.getElementById('map-wrap');
      const labels = document.querySelectorAll('#labels-container .label-box');

      const defs = svg.querySelector('defs');
      svg.innerHTML = '';
      if (defs) svg.appendChild(defs);

      const wrapRect = mapWrap.getBoundingClientRect();

      labels.forEach(label => {
        const id = label.dataset.stationId;
        const pos = stationPositions[id];
        if (!pos) return;

        const labelRect = label.getBoundingClientRect();
        const centerX = labelRect.left + labelRect.width / 2;
        const centerY = labelRect.top + labelRect.height / 2;

        const x1 = ((centerX - wrapRect.left) / wrapRect.width) * 100;
        const y1 = ((centerY - wrapRect.top) / wrapRect.height) * 100;

        const x2 = pos.left;
        const y2 = pos.top;

        const cx1 = Math.min(100, x1 + 10);
        const cy1 = y1;
        const cx2 = Math.max(0, x2 - 10);
        const cy2 = y2;

        const isMatched = matchedStations.has(id);

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', isMatched ? 'rgba(16,185,129,0.75)' : 'rgba(51,65,85,0.55)');
        path.setAttribute('stroke-width', '0.45');
        path.setAttribute('marker-end', 'url(#arrowhead)');
        svg.appendChild(path);
      });
    }

    const scheduleRedraw = () => {
      requestAnimationFrame(() => requestAnimationFrame(() => redrawLinksUsingLabelRects()));
    };

    function renderStations() {
      document.getElementById('stations-container').innerHTML = '';

      const labelsLayer = document.getElementById('labels-container');
      labelsLayer.innerHTML = '';

      stationsData.forEach((station, index) => {
        const isMatched = matchedStations.has(station.id);

        const label = document.createElement('div');
        label.className = 'label-box droppable';
        label.dataset.stationId = station.id;

        label.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="w-5 text-right">${index + 1}</span>
            <span class="flex-1">${isMatched ? station.name : 'ï¼ˆæ‹–åˆ°é€™è£¡ï¼‰'}</span>
            ${isMatched ? '<span>âœ“</span>' : '<span class="opacity-60">â¡ï¸</span>'}
          </div>
        `;

        if (isMatched) {
          label.classList.add('matched');
          label.addEventListener('click', () => showStationInfo(station));
        } else {
          label.addEventListener('dragover', (e) => { e.preventDefault(); label.classList.add('drag-over'); });
          label.addEventListener('dragleave', () => label.classList.remove('drag-over'));
          label.addEventListener('drop', (e) => {
            e.preventDefault();
            label.classList.remove('drag-over');
            const cardId = e.dataTransfer.getData('text/plain');
            if (cardId === station.id) matchStation(cardId);
          });
        }

        labelsLayer.appendChild(label);
      });

      scheduleRedraw();
    }

    function renderCards() {
      const container = document.getElementById('cards-container');
      container.innerHTML = '';

      currentCards.forEach(station => {
        if (!matchedStations.has(station.id)) {
          const card = document.createElement('div');
          card.className = 'station-card bg-gradient-to-br from-blue-400 to-indigo-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md hover:shadow-lg hover:scale-105';
          card.draggable = true;
          card.dataset.stationId = station.id;
          card.textContent = station.name;

          card.addEventListener('dragstart', (e) => {
            draggedCard = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.stationId);
          });
          card.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            draggedCard = null;
            document.querySelectorAll('.label-box').forEach(lb => lb.classList.remove('drag-over'));
          });

          card.addEventListener('touchstart', handleTouchStart, { passive: false });
          card.addEventListener('touchmove', handleTouchMove, { passive: false });
          card.addEventListener('touchend', handleTouchEnd, { passive: false });

          container.appendChild(card);
        }
      });

      if (currentCards.every(s => matchedStations.has(s.id))) {
        container.innerHTML = '<p class="text-green-600 font-bold text-lg">ğŸ‰ å¤ªæ£’äº†ï¼å…¨éƒ¨é…å°å®Œæˆï¼</p>';
      }
    }

    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      draggedCard = e.target;

      clonedCard = e.target.cloneNode(true);
      clonedCard.style.position = 'fixed';
      clonedCard.style.zIndex = '1000';
      clonedCard.style.pointerEvents = 'none';
      clonedCard.style.opacity = '0.85';
      clonedCard.style.transform = 'scale(1.1)';
      document.body.appendChild(clonedCard);

      updateClonedCardPosition(touch.clientX, touch.clientY);
    }

    function handleTouchMove(e) {
      e.preventDefault();
      if (!clonedCard) return;

      const touch = e.touches[0];
      updateClonedCardPosition(touch.clientX, touch.clientY);

      const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
      const label = elemBelow?.closest('.label-box');

      document.querySelectorAll('.label-box').forEach(lb => lb.classList.remove('drag-over'));
      if (label && !matchedStations.has(label.dataset.stationId)) label.classList.add('drag-over');
    }

    function handleTouchEnd(e) {
      e.preventDefault();
      if (!clonedCard || !draggedCard) return;

      const touch = e.changedTouches[0];
      const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
      const label = elemBelow?.closest('.label-box');

      if (label) {
        const targetId = label.dataset.stationId;
        const cardId = draggedCard.dataset.stationId;
        if (!matchedStations.has(targetId) && cardId === targetId) matchStation(cardId);
      }

      document.querySelectorAll('.label-box').forEach(lb => lb.classList.remove('drag-over'));
      clonedCard.remove();
      clonedCard = null;
      draggedCard = null;
    }

    function updateClonedCardPosition(x, y) {
      if (!clonedCard) return;
      clonedCard.style.left = (x - 40) + 'px';
      clonedCard.style.top = (y - 20) + 'px';
    }

    function matchStation(stationId) {
      matchedStations.add(stationId);
      renderStations();
      renderCards();
      updateProgress();

      const station = stationsData.find(s => s.id === stationId);
      if (station) showStationInfo(station);
    }

    function showStationInfo(station) {
      const infoContent = document.getElementById('info-content');

      const bulletsHtml = (station.bullets || [])
        .map(t => `<li class="leading-relaxed">${t}</li>`)
        .join('');

      infoContent.innerHTML = `
        <div class="bounce-in h-full flex flex-col">
          <div class="text-center">
            <h3 class="text-xl font-extrabold text-amber-900">ğŸš‰ ${station.name}</h3>
            <p class="text-xs text-amber-700 mt-1">ç‰¹è‰²çµ±æ•´èˆ‡é¢¨æ™¯åœ–</p>
          </div>

          <div class="mt-3 flex-1 rounded-2xl bg-white/70 border border-amber-200 p-3 overflow-auto">
            <div class="text-sm text-amber-900 font-bold mb-2">ç‰¹è‰²ä»‹ç´¹</div>
            <ul class="list-disc pl-5 text-amber-800 text-sm space-y-1">
              ${bulletsHtml}
            </ul>
          </div>

          <div class="mt-3 rounded-2xl bg-white/70 border border-amber-200 overflow-hidden">
            <div class="px-3 py-2 text-xs font-bold text-amber-900 bg-amber-100/60 border-b border-amber-200">
              é¢¨æ™¯åœ–
            </div>

            <div class="p-2">
              <div class="relative w-full aspect-[4/3] rounded-xl overflow-hidden bg-amber-50">
                <img
                  id="station-photo"
                  src="${station.imageUrl}"
                  alt="${station.name} é¢¨æ™¯åœ–"
                  class="zoomable-photo absolute inset-0 w-full h-full object-cover"
                  loading="lazy"
                  onerror="this.onerror=null; this.src='./fallback.jpg';"
                />
              </div>
            </div>
          </div>
        </div>
      `;

      const img = infoContent.querySelector('#station-photo');
      if (img) {
        img.addEventListener('click', () => {
          openPhotoModal(img.src, img.alt);
        });
      }
    }

    function updateProgress() {
      const total = stationsData.length;
      const matched = matchedStations.size;
      const percentage = (matched / total) * 100;
      document.getElementById('progress-fill').style.width = percentage + '%';
      document.getElementById('progress-text').textContent = `é…å°é€²åº¦ï¼š${matched} / ${total}`;
    }

    function resetGame() {
      matchedStations = new Set();
      currentCards = shuffleArray(stationsData);
      renderStations();
      renderCards();
      updateProgress();

      document.getElementById('info-content').innerHTML = `
        <div class="h-full flex flex-col">
          <div class="text-center">
            <div class="text-5xl mb-2">ğŸ—ºï¸</div>
            <p class="text-amber-800 font-bold text-lg">é»æ“Šå·²é…å°çš„æ–¹æ¡†</p>
            <p class="text-amber-700 text-sm mt-1">ä¸‹æ–¹æœƒé¡¯ç¤ºè©²ç«™ç‰¹è‰²èˆ‡é¢¨æ™¯åœ–</p>
          </div>

          <div class="mt-3 flex-1 rounded-2xl bg-white/60 border border-amber-200 p-3 flex items-center justify-center text-amber-700 text-sm">
            é¢¨æ™¯åœ–æš«å­˜å€æœƒåœ¨ä½ é»é¸è»Šç«™å¾Œå‡ºç¾ âœ¨
          </div>
        </div>
      `;

      scheduleRedraw();
    }

    function onConfigChange(config) {
      document.getElementById('game-title').textContent = config.game_title || defaultConfig.game_title;
      document.getElementById('instruction-text').textContent = config.instruction_text || defaultConfig.instruction_text;
      scheduleRedraw();
    }

    function mapToCapabilities(config) {
      return { recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['game_title', config.game_title || defaultConfig.game_title],
        ['instruction_text', config.instruction_text || defaultConfig.instruction_text]
      ]);
    }

    /* âœ… ä¿®æ”¹ï¼šé‡æ–°é–‹å§‹å‰ç¢ºèªï¼ˆé˜²èª¤è§¸ï¼‰ */
    document.getElementById('reset-btn').addEventListener('click', () => {
      const ok = confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿç›®å‰çš„é…å°é€²åº¦æœƒæ¸…é™¤ã€‚');
      if (ok) resetGame();
    });

    if (window.elementSdk) {
      window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
    }

    const mapImg = document.getElementById('rail-map');
    if (mapImg && !mapImg.complete) {
      mapImg.addEventListener('load', () => {
        resetGame();
        scheduleRedraw();
      }, { once: true });
    } else {
      resetGame();
      scheduleRedraw();
    }

    window.addEventListener('resize', scheduleRedraw);
    window.addEventListener('orientationchange', scheduleRedraw);
  </script>
</body>
</html>
