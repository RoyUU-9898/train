<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ç£éµè·¯è»Šç«™é…å°éŠæˆ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; }
    body { box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }

    .station-card { cursor: grab; transition: all 0.2s ease; user-select: none; }
    .station-card:active { cursor: grabbing; }
    .station-card.dragging { opacity: 0.7; transform: scale(1.05) rotate(2deg); }

    @keyframes bounce-in {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .bounce-in { animation: bounce-in 0.5s ease-out; }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .float-animation { animation: float 2s ease-in-out infinite; }

    .info-panel { background: linear-gradient(135deg, #fef3c7, #fde68a); }

    /* å·¦å´æ–¹æ¡† */
    .label-box {
      border-radius: 16px;
      padding: 10px 10px;
      font-weight: 700;
      font-size: 12px;
      line-height: 1.1;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(6px);
      border: 2px dashed rgba(252, 211, 77, 0.9);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      user-select: none;
    }
    .label-box.droppable { cursor: pointer; }
    .label-box.drag-over {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 0 18px rgba(34,197,94,0.35);
      border-color: rgba(34,197,94,0.9);
      background: rgba(236, 253, 245, 0.95);
    }
    .label-box.matched {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: white;
      border: none;
      cursor: pointer;
    }
    .label-box.matched:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.22);
    }

    /* âœ… å…¨é çµæ§‹ */
    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .main-content {
      flex: 1;
      min-height: 0;
    }

    /* âœ… iPad æ©«å‘ï¼šä¸æ”¹åœ–ç‰‡å‘ˆç¾æ–¹å¼ï¼Œåªç¸®æ”¾æ•´é ï¼Œé¿å…ç®­é ­é£„ */
    @media (min-width: 768px) and (max-width: 1200px) and (orientation: landscape) {
      body { overflow: hidden; }

      /* å¤–è·ç¸®å° */
      #app { padding: 6px !important; }

      header { margin-bottom: 6px !important; }
      #game-title { font-size: 22px !important; line-height: 1.2; margin-bottom: 4px !important; }
      #instruction-text { font-size: 13px !important; }

      /* âœ… æ•´é«”ç¸®æ”¾ï¼ˆé—œéµï¼‰ */
      .scale-wrap {
        transform: scale(0.92);
        transform-origin: top center;
      }

      /* å³å´é¢æ¿ç¨å¾®ç·Šæ¹Š */
      #info-panel { min-height: 210px !important; }
      #cards-container { min-height: 96px !important; }
    }
  </style>
</head>

<body class="h-full bg-gradient-to-br from-sky-100 via-blue-50 to-emerald-50 overflow-auto">
  <div id="app" class="w-full min-h-full p-4">

    <header class="text-center mb-4">
      <h1 id="game-title" class="text-2xl md:text-3xl font-bold text-blue-600 mb-2">ğŸš‚ å°ç£éµè·¯è»Šç«™é…å°éŠæˆ² ğŸšƒ</h1>
      <p id="instruction-text" class="text-gray-600 text-sm md:text-base">æŠŠå³é‚Šçš„è»Šç«™åç¨±æ‹–åˆ°å·¦é‚Šæ­£ç¢ºçš„æ–¹æ¡†å§ï¼</p>
    </header>

    <!-- âœ… iPad æ©«å‘æœƒç¸®æ”¾é€™ä¸€å±¤ï¼ˆä¸æ”¹åœ–ç‰‡ layoutï¼‰ -->
    <div class="scale-wrap">
      <div class="flex flex-col lg:flex-row gap-4 max-w-7xl mx-auto main-content">

        <!-- Left: Map -->
        <div class="lg:w-2/3 bg-white rounded-3xl shadow-xl p-4">
          <div class="flex items-center justify-center mb-3">
            <span class="text-lg font-bold text-slate-700">ğŸ—ºï¸ åŒ—è¿´ç·šéµè·¯åœ°åœ–</span>
          </div>

          <div class="relative w-full overflow-hidden rounded-3xl bg-slate-50" id="map-wrap">

            <!-- âœ… ç¶­æŒè·Ÿé›»è…¦ä¸€è‡´ï¼šwidth 100%, height autoï¼ˆä¸ä½¿ç”¨ containï¼‰ -->
            <img
              id="rail-map"
              src="https://i.ibb.co/DPC0xtz8/image-psd.jpg"
              class="w-full h-auto block select-none pointer-events-none"
              alt="rail map"
            />

            <!-- ç®­é ­ï¼šæ›´ç´°æ›´å° -->
            <svg id="links-layer"
                 class="absolute inset-0 w-full h-full pointer-events-none"
                 viewBox="0 0 100 100"
                 preserveAspectRatio="none">
              <defs>
                <marker id="arrowhead" markerWidth="4" markerHeight="4" refX="3.5" refY="2" orient="auto">
                  <path d="M0,0 L4,2 L0,4 Z" fill="rgba(51,65,85,0.75)"></path>
                </marker>
              </defs>
            </svg>

            <!-- ä¸é¡¯ç¤ºç™½é» -->
            <div id="stations-container" class="absolute inset-0 pointer-events-none"></div>

            <!-- å·¦å´æ–¹æ¡† -->
            <div id="labels-container"
                 class="absolute top-2 bottom-2 left-2 flex flex-col justify-between gap-2 w-[170px] pointer-events-auto">
            </div>
          </div>

          <p class="text-xs text-slate-500 mt-2 text-center">
            æ–¹æ¡†ç‚ºé…å°ç›®æ¨™ï¼ˆæ‹–åˆ°æ–¹æ¡†ï¼‰ï¼›é…å°å®Œæˆå¾Œå¯é»æ“Šæ–¹æ¡†æŸ¥çœ‹ç‰¹è‰²ã€‚
          </p>
        </div>

        <!-- Right Panel -->
        <div class="lg:w-1/3 flex flex-col gap-4">

          <div class="bg-white rounded-3xl shadow-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <span class="text-lg font-bold text-orange-600">ğŸ´ è»Šç«™å¡ç‰‡</span>
              <button id="reset-btn"
                class="bg-gradient-to-r from-pink-400 to-rose-400 text-white px-4 py-2 rounded-full text-sm font-bold hover:from-pink-500 hover:to-rose-500 transition-all shadow-md hover:shadow-lg">
                ğŸ”„ é‡æ–°é–‹å§‹
              </button>
            </div>

            <div id="cards-container" class="flex flex-wrap gap-2 justify-center min-h-[120px]"></div>

            <div id="progress-bar" class="mt-3 bg-gray-200 rounded-full h-3 overflow-hidden">
              <div id="progress-fill"
                class="bg-gradient-to-r from-green-400 to-emerald-500 h-full transition-all duration-500"
                style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center text-sm text-gray-500 mt-1">é…å°é€²åº¦ï¼š0 / 11</p>
          </div>

          <div id="info-panel" class="info-panel rounded-3xl shadow-xl p-4 min-h-[280px] flex flex-col items-center justify-center">
            <div id="info-content" class="text-center">
              <div class="text-6xl mb-3">ğŸš‰</div>
              <p class="text-lg text-amber-800 font-medium">
                é»æ“Šå·²é…å°çš„æ–¹æ¡†<br>ä¾†çœ‹çœ‹ç•¶åœ°çš„ç‰¹è‰²å§ï¼
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    const defaultConfig = {
      game_title: 'ğŸš‚ å°ç£éµè·¯è»Šç«™é…å°éŠæˆ² ğŸšƒ',
      instruction_text: 'æŠŠå³é‚Šçš„è»Šç«™åç¨±æ‹–åˆ°å·¦é‚Šæ­£ç¢ºçš„æ–¹æ¡†å§ï¼'
    };

    const stationsData = [
      { id: 'songshan', name: 'æ¾å±±', description: 'æ¾å±±æ˜¯å°åŒ—é‡è¦çš„äº¤é€šæ¨ç´ï¼Œé€™è£¡æœ‰ç†±é¬§çš„é¥’æ²³å¤œå¸‚ï¼Œå¯ä»¥åƒåˆ°å„ç¨®ç¾å‘³çš„å°åƒå–”ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="10" y="40" width="80" height="50" rx="5" fill="#FF6B6B"/>
          <rect x="15" y="45" width="15" height="20" rx="2" fill="#FFE66D"/>
          <rect x="35" y="45" width="15" height="20" rx="2" fill="#4ECDC4"/>
          <rect x="55" y="45" width="15" height="20" rx="2" fill="#FFE66D"/>
          <rect x="75" y="45" width="10" height="15" rx="2" fill="#4ECDC4"/>
          <text x="50" y="82" text-anchor="middle" fill="white" font-size="10" font-weight="bold">å¤œå¸‚</text>
          <circle cx="25" cy="25" r="12" fill="#FFD93D"/>
          <text x="25" y="29" text-anchor="middle" fill="#FF6B6B" font-size="12">ğŸœ</text>
          <circle cx="75" cy="25" r="12" fill="#6BCB77"/>
          <text x="75" y="29" text-anchor="middle" fill="white" font-size="12">ğŸšƒ</text>
        </svg>` },
      { id: 'ruifang', name: 'ç‘èŠ³', description: 'ç‘èŠ³æ˜¯é€šå¾€ä¹ä»½å±±åŸçš„é–€æˆ¶ï¼Œé€™è£¡æ›¾ç¶“æ˜¯æ¡é‡‘ç¤¦çš„åœ°æ–¹ï¼Œæœ‰è‘—è±å¯Œçš„ç¤¦æ¥­æ–‡åŒ–ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <polygon points="50,10 20,50 80,50" fill="#8B7355"/>
          <polygon points="50,25 30,50 70,50" fill="#A0522D"/>
          <rect x="25" y="50" width="15" height="25" rx="2" fill="#CD853F"/>
          <rect x="45" y="45" width="18" height="30" rx="2" fill="#DEB887"/>
          <rect x="68" y="55" width="12" height="20" rx="2" fill="#CD853F"/>
          <circle cx="75" cy="30" r="8" fill="#FFD700"/>
          <text x="75" y="34" text-anchor="middle" fill="#8B4513" font-size="10">â›ï¸</text>
          <rect x="30" y="80" width="40" height="8" rx="2" fill="#696969"/>
          <circle cx="38" cy="88" r="4" fill="#333"/>
          <circle cx="62" cy="88" r="4" fill="#333"/>
        </svg>` },
      { id: 'houtong', name: 'çŒ´ç¡', description: 'çŒ´ç¡æ˜¯è‘—åçš„è²“æ‘ï¼Œæœ‰å¥½å¤šå¯æ„›çš„è²“å’ªåœ¨è»Šç«™é™„è¿‘æ•£æ­¥ï¼Œæ˜¯è²“å’ªæ„›å¥½è€…çš„å¤©å ‚ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <ellipse cx="50" cy="65" rx="30" ry="25" fill="#FFA07A"/>
          <ellipse cx="50" cy="45" rx="20" ry="18" fill="#FFA07A"/>
          <polygon points="35,30 40,45 30,45" fill="#FFA07A"/>
          <polygon points="65,30 70,45 60,45" fill="#FFA07A"/>
          <polygon points="35,28 40,43 28,43" fill="#FFB6C1"/>
          <polygon points="65,28 72,43 60,43" fill="#FFB6C1"/>
          <circle cx="42" cy="42" r="4" fill="#333"/>
          <circle cx="58" cy="42" r="4" fill="#333"/>
          <circle cx="43" cy="43" r="1.5" fill="white"/>
          <circle cx="59" cy="43" r="1.5" fill="white"/>
          <ellipse cx="50" cy="52" rx="3" ry="2" fill="#FF69B4"/>
          <path d="M47,55 Q50,58 53,55" stroke="#333" stroke-width="1.5" fill="none"/>
          <line x1="30" y1="48" x2="20" y2="45" stroke="#333" stroke-width="1"/>
          <line x1="30" y1="52" x2="20" y2="52" stroke="#333" stroke-width="1"/>
          <line x1="70" y1="48" x2="80" y2="45" stroke="#333" stroke-width="1"/>
          <line x1="70" y1="52" x2="80" y2="52" stroke="#333" stroke-width="1"/>
          <ellipse cx="35" cy="70" rx="8" ry="6" fill="#FFA07A"/>
          <ellipse cx="65" cy="70" rx="8" ry="6" fill="#FFA07A"/>
          <path d="M75,65 Q85,55 80,75" stroke="#FFA07A" stroke-width="8" fill="none" stroke-linecap="round"/>
        </svg>` },
      { id: 'sandiaoling', name: 'ä¸‰è²‚å¶º', description: 'ä¸‰è²‚å¶ºæ˜¯ä¸€å€‹ç§˜å¢ƒè»Šç«™ï¼Œé™„è¿‘æœ‰ç¾éº—çš„ç€‘å¸ƒå’ŒåŸå§‹çš„è‡ªç„¶é¢¨å…‰ï¼Œæ˜¯æ¢éšªçš„å¥½åœ°æ–¹ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <polygon points="20,90 35,40 50,90" fill="#228B22"/>
          <polygon points="50,90 65,30 80,90" fill="#2E8B57"/>
          <polygon points="35,90 50,50 65,90" fill="#32CD32"/>
          <path d="M70,20 Q72,50 75,50 Q73,50 75,80" stroke="#87CEEB" stroke-width="6" fill="none"/>
          <path d="M72,20 Q74,50 77,50 Q75,50 77,80" stroke="#B0E0E6" stroke-width="3" fill="none"/>
          <ellipse cx="75" cy="85" rx="10" ry="5" fill="#87CEEB" opacity="0.7"/>
          <circle cx="20" cy="25" r="6" fill="white" opacity="0.8"/>
          <circle cx="28" cy="22" r="4" fill="white" opacity="0.8"/>
          <circle cx="15" cy="20" r="3" fill="white" opacity="0.8"/>
        </svg>` },
      { id: 'mudan', name: 'ç‰¡ä¸¹', description: 'ç‰¡ä¸¹æ˜¯ä¸€å€‹å¯§éœç´”æ¨¸çš„é„‰æ‘å°ç«™ï¼Œå‘¨åœæœ‰ç¾éº—çš„ç”°åœ’é¢¨å…‰å’Œç››é–‹çš„èŠ±æœµï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="0" y="60" width="100" height="40" fill="#90EE90"/>
          <rect x="0" y="70" width="100" height="30" fill="#7CFC00"/>
          <circle cx="30" cy="40" r="15" fill="#FF69B4"/>
          <circle cx="30" cy="40" r="8" fill="#FFB6C1"/>
          <circle cx="30" cy="40" r="4" fill="#FFD700"/>
          <circle cx="70" cy="35" r="12" fill="#FF6347"/>
          <circle cx="70" cy="35" r="6" fill="#FFA07A"/>
          <circle cx="70" cy="35" r="3" fill="#FFD700"/>
          <circle cx="50" cy="50" r="10" fill="#9370DB"/>
          <circle cx="50" cy="50" r="5" fill="#DDA0DD"/>
          <circle cx="50" cy="50" r="2" fill="#FFD700"/>
          <line x1="30" y1="55" x2="30" y2="75" stroke="#228B22" stroke-width="3"/>
          <line x1="70" y1="47" x2="70" y2="70" stroke="#228B22" stroke-width="3"/>
          <line x1="50" y1="60" x2="50" y2="78" stroke="#228B22" stroke-width="3"/>
          <ellipse cx="25" cy="75" rx="8" ry="3" fill="#32CD32"/>
          <ellipse cx="55" cy="78" rx="6" ry="2" fill="#32CD32"/>
          <circle cx="85" cy="20" r="12" fill="#FFD700"/>
        </svg>` },
      { id: 'shuangxi', name: 'é›™æºª', description: 'é›™æºªæœ‰å¤è€çš„æˆ¿å±‹å’Œæ¸…æ¾ˆçš„æºªæµï¼Œèµ°åœ¨è€è¡—ä¸Šå¯ä»¥æ„Ÿå—åˆ°æ¿ƒæ¿ƒçš„æ‡·èˆŠæ°£æ¯ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="15" y="35" width="35" height="35" fill="#8B4513"/>
          <polygon points="15,35 32,15 50,35" fill="#A0522D"/>
          <rect x="25" y="50" width="10" height="20" fill="#DEB887"/>
          <rect x="38" y="45" width="8" height="8" fill="#87CEEB"/>
          <rect x="55" y="40" width="30" height="30" fill="#CD853F"/>
          <polygon points="55,40 70,25 85,40" fill="#8B7355"/>
          <rect x="65" y="55" width="10" height="15" fill="#DEB887"/>
          <rect x="78" y="48" width="6" height="6" fill="#87CEEB"/>
          <path d="M0,85 Q25,75 50,85 Q75,95 100,85" fill="#87CEEB"/>
          <path d="M0,88 Q25,78 50,88 Q75,98 100,88" fill="#B0E0E6"/>
          <ellipse cx="30" cy="83" rx="4" ry="2" fill="#4682B4"/>
          <ellipse cx="70" cy="87" rx="3" ry="1.5" fill="#4682B4"/>
        </svg>` },
      { id: 'gongliao', name: 'è²¢å¯®', description: 'è²¢å¯®é è¿‘æ±åŒ—è§’æµ·å²¸ï¼Œé€™è£¡æœ‰å±±æµ·æ™¯è‰²å’Œå¯§éœçš„èšè½æ°›åœï¼Œä¹Ÿå¾ˆé©åˆå®‰æ’è¼•æ—…è¡Œï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="0" y="60" width="100" height="40" fill="#7dd3fc"/>
          <path d="M0,60 Q25,52 50,60 Q75,68 100,60" fill="#38bdf8"/>
          <polygon points="10,80 30,40 50,80" fill="#22c55e"/>
          <polygon points="40,85 60,45 80,85" fill="#16a34a"/>
          <circle cx="78" cy="22" r="10" fill="#facc15"/>
          <circle cx="20" cy="70" r="4" fill="white" opacity="0.9"/>
          <circle cx="30" cy="74" r="3" fill="white" opacity="0.9"/>
        </svg>` },
      { id: 'fulong', name: 'ç¦éš†', description: 'ç¦éš†æœ‰ç¾éº—çš„é‡‘è‰²æ²™ç˜ï¼Œæ¯å¹´å¤å¤©é‚„æœƒèˆ‰è¾¦ç†±é¬§çš„æµ·æ´‹éŸ³æ¨‚ç¥­ï¼Œè¶…ç´šå¥½ç©ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="0" y="0" width="100" height="50" fill="#87CEEB"/>
          <circle cx="80" cy="25" r="15" fill="#FFD700"/>
          <path d="M0,50 Q50,40 100,50 L100,70 Q50,60 0,70 Z" fill="#F4A460"/>
          <rect x="0" y="65" width="100" height="35" fill="#DEB887"/>
          <rect x="35" y="45" width="3" height="30" fill="#8B4513"/>
          <polygon points="38,30 38,55 55,42" fill="#FF6347"/>
          <ellipse cx="20" cy="75" rx="8" ry="4" fill="#FFE4B5"/>
          <ellipse cx="75" cy="80" rx="6" ry="3" fill="#FFE4B5"/>
          <path d="M5,55 Q10,52 15,55 Q20,58 25,55" stroke="#4682B4" stroke-width="2" fill="none"/>
          <path d="M60,52 Q65,49 70,52 Q75,55 80,52" stroke="#4682B4" stroke-width="2" fill="none"/>
          <text x="50" y="90" text-anchor="middle" fill="#8B4513" font-size="8">ğŸµğŸ¶</text>
        </svg>` },
      { id: 'yilan', name: 'å®œè˜­', description: 'å®œè˜­æ˜¯ä¸€å€‹å……æ»¿ç«¥è¶£çš„åŸå¸‚ï¼Œæœ‰å¾ˆå¤šè¦ªå­æ™¯é»å’Œæœ‰è¶£çš„åšç‰©é¤¨ï¼Œé‚„æœ‰ç¾å‘³çš„å°åƒï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="10" y="40" width="25" height="40" rx="3" fill="#FF6B6B"/>
          <rect x="38" y="30" width="25" height="50" rx="3" fill="#4ECDC4"/>
          <rect x="66" y="45" width="25" height="35" rx="3" fill="#FFE66D"/>
          <rect x="15" y="50" width="8" height="10" rx="1" fill="#FFE66D"/>
          <rect x="22" y="65" width="8" height="15" rx="1" fill="#87CEEB"/>
          <rect x="43" y="40" width="8" height="10" rx="1" fill="#FF6B6B"/>
          <rect x="53" y="55" width="8" height="10" rx="1" fill="#FFE66D"/>
          <rect x="45" y="65" width="10" height="15" rx="1" fill="#DEB887"/>
          <rect x="71" y="55" width="8" height="8" rx="1" fill="#4ECDC4"/>
          <rect x="81" y="65" width="6" height="15" rx="1" fill="#FF6B6B"/>
          <polygon points="10,40 22,25 35,40" fill="#FF8E8E"/>
          <polygon points="38,30 50,15 63,30" fill="#7FDFDF"/>
          <polygon points="66,45 78,32 91,45" fill="#FFF085"/>
          <circle cx="50" cy="10" r="4" fill="#FF69B4"/>
          <circle cx="20" cy="88" r="6" fill="#9370DB"/>
          <circle cx="80" cy="88" r="5" fill="#FF6B6B"/>
        </svg>` },
      { id: 'suao', name: 'è˜‡æ¾³', description: 'è˜‡æ¾³æ˜¯ä¸€å€‹æ¼æ¸¯å°é®ï¼Œæœ‰æ–°é®®çš„æµ·é®®å’Œç‰¹åˆ¥çš„å†·æ³‰ï¼Œæ³¡å†·æ³‰æ¶ˆæš‘æœ€æ£’äº†ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="0" y="50" width="100" height="50" fill="#4682B4"/>
          <path d="M0,50 Q25,45 50,50 Q75,55 100,50" fill="#87CEEB"/>
          <path d="M10,60 L20,40 L30,60 Z" fill="#DEB887"/>
          <rect x="15" y="60" width="10" height="15" fill="#8B4513"/>
          <rect x="12" y="40" width="16" height="8" fill="#CD853F"/>
          <polygon points="18,30 20,40 22,30 24,40 26,30" fill="#FFD700"/>
          <ellipse cx="70" cy="70" rx="15" ry="8" fill="#FF6347"/>
          <circle cx="65" cy="68" r="2" fill="#333"/>
          <polygon points="85,68 90,70 85,72" fill="#FF6347"/>
          <ellipse cx="50" cy="80" rx="10" ry="5" fill="#FFA500"/>
          <circle cx="47" cy="79" r="1.5" fill="#333"/>
          <polygon points="60,79 64,80 60,81" fill="#FFA500"/>
          <circle cx="75" cy="25" r="12" fill="#87CEEB" opacity="0.7"/>
          <path d="M70,28 Q75,22 80,28" stroke="#4682B4" stroke-width="2" fill="none"/>
          <text x="75" y="35" text-anchor="middle" fill="#4682B4" font-size="6">å†·æ³‰</text>
        </svg>` },
      { id: 'hualien', name: 'èŠ±è“®', description: 'èŠ±è“®æœ‰å£¯éº—çš„å¤ªé­¯é–£å³½è°·å’Œç¾éº—çš„æµ·å²¸ç·šï¼Œæ˜¯å°ç£æœ€ç¾çš„åœ°æ–¹ä¹‹ä¸€ï¼',
        svg: `<svg viewBox="0 0 100 100" class="w-full h-full">
          <rect x="0" y="70" width="100" height="30" fill="#4682B4"/>
          <path d="M0,70 Q50,60 100,70" fill="#87CEEB"/>
          <polygon points="0,70 20,20 40,70" fill="#696969"/>
          <polygon points="30,70 50,15 70,70" fill="#808080"/>
          <polygon points="60,70 80,25 100,70" fill="#696969"/>
          <path d="M35,40 L35,70" stroke="#B0C4DE" stroke-width="3"/>
          <path d="M65,35 L65,70" stroke="#B0C4DE" stroke-width="3"/>
          <path d="M0,75 Q25,72 50,75 Q75,78 100,75" stroke="white" stroke-width="2" fill="none"/>
          <path d="M0,80 Q25,77 50,80 Q75,83 100,80" stroke="white" stroke-width="1.5" fill="none" opacity="0.7"/>
          <circle cx="85" cy="20" r="10" fill="#FFD700"/>
          <circle cx="15" cy="15" r="5" fill="white" opacity="0.8"/>
          <circle cx="22" cy="12" r="3" fill="white" opacity="0.8"/>
        </svg>` },
    ];

    const stationPositions = {
      songshan:    { left: 71.3921, top: 21.7455 },
      ruifang:     { left: 83.8485, top: 17.3941 },
      houtong:     { left: 85.3277, top: 18.6803 },
      sandiaoling: { left: 85.1615, top: 20.6331 },
      mudan:       { left: 87.6282, top: 21.2583 },
      shuangxi:    { left: 87.9982, top: 23.2591 },
      gongliao:    { left: 90.9581, top: 23.5092 },
      fulong:      { left: 93.2906, top: 24.2098 },
      yilan:       { left: 81.9706, top: 40.8866 },
      suao:        { left: 88.0022, top: 51.8680 },
      hualien:     { left: 73.1468, top: 91.5765 },
    };

    let matchedStations = new Set();
    let currentCards = [];
    let draggedCard = null;
    let clonedCard = null;

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function redrawLinksUsingLabelRects() {
      const svg = document.getElementById('links-layer');
      const mapWrap = document.getElementById('map-wrap');
      const labels = document.querySelectorAll('#labels-container .label-box');

      const defs = svg.querySelector('defs');
      svg.innerHTML = '';
      if (defs) svg.appendChild(defs);

      const wrapRect = mapWrap.getBoundingClientRect();

      labels.forEach(label => {
        const id = label.dataset.stationId;
        const pos = stationPositions[id];
        if (!pos) return;

        // èµ·é»ï¼šæ–¹æ¡†ä¸­å¿ƒï¼ˆè½‰ç‚º map-wrap çš„ç™¾åˆ†æ¯”ï¼‰
        const labelRect = label.getBoundingClientRect();
        const centerX = labelRect.left + labelRect.width / 2;
        const centerY = labelRect.top + labelRect.height / 2;

        const x1 = ((centerX - wrapRect.left) / wrapRect.width) * 100;
        const y1 = ((centerY - wrapRect.top) / wrapRect.height) * 100;

        // çµ‚é»ï¼šç›´æ¥ç”¨ stationPositionsï¼ˆå› ç‚ºåœ–ç‰‡æ’ç‰ˆè·Ÿé›»è…¦ä¸€è‡´ï¼Œä¸æœƒæœ‰ contain ç•™ç™½ï¼‰
        const x2 = pos.left;
        const y2 = pos.top;

        const cx1 = Math.min(100, x1 + 10);
        const cy1 = y1;
        const cx2 = Math.max(0, x2 - 10);
        const cy2 = y2;

        const isMatched = matchedStations.has(id);

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', isMatched ? 'rgba(16,185,129,0.75)' : 'rgba(51,65,85,0.55)');
        path.setAttribute('stroke-width', '0.45');
        path.setAttribute('marker-end', 'url(#arrowhead)');
        svg.appendChild(path);
      });
    }

    const scheduleRedraw = () => {
      requestAnimationFrame(() => requestAnimationFrame(() => redrawLinksUsingLabelRects()));
    };

    function renderStations() {
      document.getElementById('stations-container').innerHTML = ''; // ä¸é¡¯ç¤ºç™½é»

      const labelsLayer = document.getElementById('labels-container');
      labelsLayer.innerHTML = '';

      stationsData.forEach((station, index) => {
        const isMatched = matchedStations.has(station.id);

        const label = document.createElement('div');
        label.className = 'label-box droppable';
        label.dataset.stationId = station.id;

        label.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="w-5 text-right">${index + 1}</span>
            <span class="flex-1">${isMatched ? station.name : 'ï¼ˆæ‹–åˆ°é€™è£¡ï¼‰'}</span>
            ${isMatched ? '<span>âœ“</span>' : '<span class="opacity-60">â¡ï¸</span>'}
          </div>
        `;

        if (isMatched) {
          label.classList.add('matched');
          label.addEventListener('click', () => showStationInfo(station));
        } else {
          label.addEventListener('dragover', (e) => { e.preventDefault(); label.classList.add('drag-over'); });
          label.addEventListener('dragleave', () => label.classList.remove('drag-over'));
          label.addEventListener('drop', (e) => {
            e.preventDefault();
            label.classList.remove('drag-over');
            const cardId = e.dataTransfer.getData('text/plain');
            if (cardId === station.id) matchStation(cardId);
          });
        }

        labelsLayer.appendChild(label);
      });

      scheduleRedraw();
    }

    function renderCards() {
      const container = document.getElementById('cards-container');
      container.innerHTML = '';

      currentCards.forEach(station => {
        if (!matchedStations.has(station.id)) {
          const card = document.createElement('div');
          card.className = 'station-card bg-gradient-to-br from-blue-400 to-indigo-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md hover:shadow-lg hover:scale-105';
          card.draggable = true;
          card.dataset.stationId = station.id;
          card.textContent = station.name;

          card.addEventListener('dragstart', (e) => {
            draggedCard = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.stationId);
          });
          card.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            draggedCard = null;
            document.querySelectorAll('.label-box').forEach(lb => lb.classList.remove('drag-over'));
          });

          // touch
          card.addEventListener('touchstart', handleTouchStart, { passive: false });
          card.addEventListener('touchmove', handleTouchMove, { passive: false });
          card.addEventListener('touchend', handleTouchEnd, { passive: false });

          container.appendChild(card);
        }
      });

      if (currentCards.every(s => matchedStations.has(s.id))) {
        container.innerHTML = '<p class="text-green-600 font-bold text-lg">ğŸ‰ å¤ªæ£’äº†ï¼å…¨éƒ¨é…å°å®Œæˆï¼</p>';
      }
    }

    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      draggedCard = e.target;

      clonedCard = e.target.cloneNode(true);
      clonedCard.style.position = 'fixed';
      clonedCard.style.zIndex = '1000';
      clonedCard.style.pointerEvents = 'none';
      clonedCard.style.opacity = '0.85';
      clonedCard.style.transform = 'scale(1.1)';
      document.body.appendChild(clonedCard);

      updateClonedCardPosition(touch.clientX, touch.clientY);
    }

    function handleTouchMove(e) {
      e.preventDefault();
      if (!clonedCard) return;

      const touch = e.touches[0];
      updateClonedCardPosition(touch.clientX, touch.clientY);

      const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
      const label = elemBelow?.closest('.label-box');

      document.querySelectorAll('.label-box').forEach(lb => lb.classList.remove('drag-over'));
      if (label && !matchedStations.has(label.dataset.stationId)) label.classList.add('drag-over');
    }

    function handleTouchEnd(e) {
      e.preventDefault();
      if (!clonedCard || !draggedCard) return;

      const touch = e.changedTouches[0];
      const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
      const label = elemBelow?.closest('.label-box');

      if (label) {
        const targetId = label.dataset.stationId;
        const cardId = draggedCard.dataset.stationId;
        if (!matchedStations.has(targetId) && cardId === targetId) matchStation(cardId);
      }

      document.querySelectorAll('.label-box').forEach(lb => lb.classList.remove('drag-over'));
      clonedCard.remove();
      clonedCard = null;
      draggedCard = null;
    }

    function updateClonedCardPosition(x, y) {
      if (!clonedCard) return;
      clonedCard.style.left = (x - 40) + 'px';
      clonedCard.style.top = (y - 20) + 'px';
    }

    function matchStation(stationId) {
      matchedStations.add(stationId);
      renderStations();
      renderCards();
      updateProgress();

      const station = stationsData.find(s => s.id === stationId);
      if (station) showStationInfo(station);
    }

    function showStationInfo(station) {
      const infoContent = document.getElementById('info-content');
      infoContent.innerHTML = `
        <div class="bounce-in">
          <h3 class="text-xl font-bold text-amber-800 mb-3">ğŸš‰ ${station.name}è»Šç«™</h3>
          <div class="w-32 h-32 mx-auto mb-3 float-animation">
            ${station.svg}
          </div>
          <p class="text-amber-700 text-sm leading-relaxed px-2">${station.description}</p>
        </div>
      `;
    }

    function updateProgress() {
      const total = stationsData.length;
      const matched = matchedStations.size;
      const percentage = (matched / total) * 100;
      document.getElementById('progress-fill').style.width = percentage + '%';
      document.getElementById('progress-text').textContent = `é…å°é€²åº¦ï¼š${matched} / ${total}`;
    }

    function resetGame() {
      matchedStations = new Set();
      currentCards = shuffleArray(stationsData);
      renderStations();
      renderCards();
      updateProgress();

      document.getElementById('info-content').innerHTML = `
        <div class="text-6xl mb-3">ğŸš‰</div>
        <p class="text-lg text-amber-800 font-medium">
          é»æ“Šå·²é…å°çš„æ–¹æ¡†<br>ä¾†çœ‹çœ‹ç•¶åœ°çš„ç‰¹è‰²å§ï¼
        </p>
      `;

      scheduleRedraw();
    }

    function onConfigChange(config) {
      document.getElementById('game-title').textContent = config.game_title || defaultConfig.game_title;
      document.getElementById('instruction-text').textContent = config.instruction_text || defaultConfig.instruction_text;
      scheduleRedraw();
    }

    function mapToCapabilities(config) {
      return { recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['game_title', config.game_title || defaultConfig.game_title],
        ['instruction_text', config.instruction_text || defaultConfig.instruction_text]
      ]);
    }

    document.getElementById('reset-btn').addEventListener('click', resetGame);

    if (window.elementSdk) {
      window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
    }

    const mapImg = document.getElementById('rail-map');
    if (mapImg && !mapImg.complete) {
      mapImg.addEventListener('load', () => {
        resetGame();
        scheduleRedraw();
      }, { once: true });
    } else {
      resetGame();
      scheduleRedraw();
    }

    window.addEventListener('resize', scheduleRedraw);
    window.addEventListener('orientationchange', scheduleRedraw);
  </script>
</body>
</html>
